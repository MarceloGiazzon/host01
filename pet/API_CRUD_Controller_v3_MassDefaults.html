<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prueba CV - API Client v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        .input-group label { display: block; font-size: 0.75rem; font-weight: 600; color: #4b5563; margin-bottom: 0.25rem; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.5rem; font-size: 0.875rem; }
        .log-entry { font-family: monospace; font-size: 10px; border-bottom: 1px solid #374151; padding: 4px 0; word-break: break-all; }
        .log-request { color: #60a5fa; }
        .log-response { color: #34d399; }
        .log-error { color: #f87171; }
        .hash-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; display: inline-block; margin-top: 4px; }
        .item-card { border: 1px solid #e5e7eb; border-radius: 0.75rem; padding: 1rem; background: white; transition: box-shadow 0.2s; }
        .item-card:hover { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        
        .modal-overlay { 
            background: rgba(0,0,0,0.7); 
            backdrop-filter: blur(2px); 
            display: none;
        }
        .modal-overlay.active {
            display: flex;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800 font-sans">

    <!-- Debug Modal -->
    <div id="debugModal" class="modal-overlay fixed inset-0 z-50 items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full overflow-hidden border border-gray-200">
            <div class="bg-slate-800 p-4 flex justify-between items-center">
                <h3 class="text-white font-bold text-sm uppercase tracking-wider">Outgoing Payload Preview</h3>
                <span id="debugTarget" class="text-xs text-slate-400 font-mono"></span>
            </div>
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-4">Review the data structure below. All schema fields included.</p>
                <pre id="debugPayload" class="bg-gray-900 text-blue-300 p-4 rounded-lg text-xs overflow-auto max-h-80 font-mono"></pre>
                <div class="mt-6 flex justify-end gap-3">
                    <button onclick="cancelRequest()" class="px-4 py-2 text-xs font-bold text-gray-600 hover:bg-gray-100 rounded-lg">ABORT REQUEST</button>
                    <button id="confirmRequestBtn" class="px-6 py-2 text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-lg">PROCEED TO SERVER</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto py-10 px-4">
        <header class="mb-8 text-center">
            <h1 class="text-3xl font-bold text-gray-900 tracking-tight">API CRUD Controller v3</h1>
            <p class="text-gray-600 mt-2">Enhanced Schema Support & Batch Generation</p>
            
            <div class="mt-4 p-4 bg-slate-800 border border-slate-700 rounded-lg inline-block text-left max-w-2xl shadow-lg">
                <div class="flex flex-wrap items-center gap-4">
                    <div class="flex items-center gap-2">
                        <select id="proxySelector" class="text-xs p-1 border rounded bg-slate-700 text-white border-slate-600 outline-none">
                            <option value="corsproxy_io" selected>corsproxy.io (Default)</option>
                            <option value="none">Direct (No Proxy)</option>
                        </select>
                    </div>

                    <div class="flex items-center gap-3 border-l border-slate-600 pl-4 flex-wrap">
                        <label class="text-white text-[10px] flex items-center gap-1">
                            <input type="checkbox" id="postWithId" checked> POST with ID (/0)
                        </label>
                        <label class="text-yellow-400 text-[10px] flex items-center gap-1 font-bold ml-2">
                            <input type="checkbox" id="inspectData" checked> INSPECT DATA
                        </label>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white rounded-xl shadow-sm mb-6 overflow-hidden border border-gray-200">
            <nav class="flex border-b bg-gray-50 overflow-x-auto">
                <button onclick="switchTab('activity')" id="tab-activity" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition tab-active">Activities</button>
                <button onclick="switchTab('product')" id="tab-product" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition text-gray-400">Products</button>
                <button onclick="switchTab('user')" id="tab-user" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition text-gray-400">Users</button>
                <button onclick="switchTab('batch')" id="tab-batch" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition text-gray-400">Batch User</button>
                <button onclick="switchTab('batchProduct')" id="tab-batchProduct" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition text-gray-400">Batch Product</button>
                <button onclick="switchTab('batchActivity')" id="tab-batchActivity" class="tab-btn min-w-[100px] py-4 text-center font-bold text-[10px] uppercase tracking-widest transition text-gray-400">Batch Activity</button>
            </nav>

            <div class="p-6">
                <!-- Activity Form -->
                <div id="section-activity" class="tab-section">
                    <form id="activityForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="input-group">
                                <label>ActivityId (Key)</label>
                                <input type="number" name="ActivityId" value="0">
                            </div>
                            <div class="input-group">
                                <label>ActivityUserId</label>
                                <input type="number" name="ActivityUserId" value="1">
                            </div>
                            <div class="input-group">
                                <label>ActivityProductId</label>
                                <input type="number" name="ActivityProductId" value="0">
                            </div>
                            <div class="input-group">
                                <label>ActivityType</label>
                                <select name="ActivityType">
                                    <option value="Search">Search</option>
                                    <option value="Offer">Offer</option>
                                    <option value="Post">Post</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>ActivityStatus</label>
                                <select name="ActivityStatus">
                                    <option value="Active">Active</option>
                                    <option value="Finished">Finished</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>ActivityDateTime</label>
                                <input type="text" name="ActivityDateTime" placeholder="Auto-generated">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>ActivityDescription</label>
                            <textarea name="ActivityDescription" rows="2">Standard activity</textarea>
                        </div>
                        <div id="activityHashDisplay" class="hash-badge bg-gray-200 text-gray-600">No Hash</div>
                        <div class="flex flex-wrap gap-2 pt-2">
                            <button type="button" onclick="apiCall('Activity', 'GET')" class="bg-gray-100 px-4 py-2 rounded-lg font-bold text-xs">FIND</button>
                            <button type="button" onclick="apiCall('Activity', 'POST')" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold text-xs">CREATE</button>
                        </div>
                    </form>
                </div>

                <!-- Product Form -->
                <div id="section-product" class="tab-section hidden">
                    <form id="productForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="input-group">
                                <label>ProductId (Key)</label>
                                <input type="number" name="ProductId" value="0">
                            </div>
                            <div class="input-group">
                                <label>ProductName</label>
                                <input type="text" name="ProductName" value="New Item">
                            </div>
                            <div class="input-group">
                                <label>ProductManufacturer</label>
                                <input type="text" name="ProductManufacturer" value="Genexus">
                            </div>
                            <div class="input-group">
                                <label>ProductCategory</label>
                                <select name="ProductCategory">
                                    <option value="Cloth">Cloth</option>
                                    <option value="Toy">Toy</option>
                                    <option value="Book">Book</option>
                                    <option value="Accessory">Accessory</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>ProductEANCode</label>
                                <input type="text" name="ProductEANCode" value="789000">
                            </div>
                            <div class="input-group">
                                <label>ProductImage URL</label>
                                <input type="text" name="ProductImage" value="https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop">
                            </div>
                        </div>
                        <div class="input-group">
                            <label>ProductDescription</label>
                            <textarea name="ProductDescription" rows="2">Standard product</textarea>
                        </div>
                        <div id="productHashDisplay" class="hash-badge bg-gray-200 text-gray-600">No Hash</div>
                        <div class="flex gap-2 pt-2">
                            <button type="button" onclick="apiCall('Product', 'GET')" class="bg-gray-100 px-4 py-2 rounded-lg font-bold text-xs">FIND</button>
                            <button type="button" onclick="apiCall('Product', 'POST')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold text-xs">CREATE</button>
                        </div>
                    </form>
                </div>

                <!-- User Form -->
                <div id="section-user" class="tab-section hidden">
                    <form id="userForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="input-group">
                                <label>UserId (Key)</label>
                                <input type="number" name="UserId" value="0">
                            </div>
                            <div class="input-group">
                                <label>UserName</label>
                                <input type="text" name="UserName" value="John Doe">
                            </div>
                            <div class="input-group">
                                <label>UserEmail</label>
                                <input type="email" name="UserEmail" value="john@example.com">
                            </div>
                            <div class="input-group">
                                <label>UserPassword</label>
                                <input type="text" name="UserPassword" value="pwd123">
                            </div>
                            <div class="input-group">
                                <label>UserCity</label>
                                <input type="text" name="UserCity" value="New York">
                            </div>
                            <div class="input-group">
                                <label>UserZone</label>
                                <input type="text" name="UserZone" value="East">
                            </div>
                            <div class="input-group">
                                <label>UserProfileImage</label>
                                <input type="text" name="UserProfileImage" value="https://i.pravatar.cc/150">
                            </div>
                            <div class="input-group">
                                <label>Inactive</label>
                                <select name="UserInactive">
                                    <option value="false">False</option>
                                    <option value="true">True</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Verified</label>
                                <select name="UserVerified">
                                    <option value="true">True</option>
                                    <option value="false">False</option>
                                </select>
                            </div>
                        </div>
                        <div id="userHashDisplay" class="hash-badge bg-gray-200 text-gray-600">No Hash</div>
                        <div class="flex gap-2 pt-2">
                            <button type="button" onclick="apiCall('User', 'GET')" class="bg-gray-100 px-4 py-2 rounded-lg font-bold text-xs">FIND</button>
                            <button type="button" onclick="apiCall('User', 'POST')" class="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold text-xs">CREATE</button>
                        </div>
                    </form>
                </div>

                <!-- Batch Activity -->
                <div id="section-batchActivity" class="tab-section hidden">
                    <div class="space-y-4">
                        <div class="flex items-end gap-4">
                            <div class="input-group max-w-[120px]">
                                <label>Quantity</label>
                                <input type="number" id="activityBatchQty" value="5" min="1" max="50">
                            </div>
                            <button onclick="fetchExistingAndGenerateActivities()" class="bg-purple-600 text-white px-6 py-2 rounded-lg font-bold text-xs h-[38px]">SYNC & GENERATE</button>
                        </div>
                        <div id="batchActivityContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                        <div id="batchActivityActions" class="hidden flex justify-end gap-2 pt-4 border-t">
                            <button onclick="processBatchCreation('Activity', 'activity')" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold text-xs">CREATE ALL</button>
                        </div>
                    </div>
                </div>

                <!-- Batch Product -->
                <div id="section-batchProduct" class="tab-section hidden">
                    <div class="space-y-4">
                        <div class="flex items-end gap-4">
                            <div class="input-group max-w-[120px]">
                                <label>Quantity</label>
                                <input type="number" id="productBatchQty" value="5" min="1" max="50">
                            </div>
                            <button onclick="generateBatchProducts()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold text-xs h-[38px]">GENERATE PRODUCTS</button>
                        </div>
                        <div id="batchProductContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                        <div id="batchProductActions" class="hidden flex justify-end gap-2 pt-4 border-t">
                            <button onclick="processBatchCreation('Product', 'product')" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-xs">CREATE ALL</button>
                        </div>
                    </div>
                </div>

                <!-- Batch User -->
                <div id="section-batch" class="tab-section hidden">
                    <div class="space-y-4">
                        <div class="flex items-end gap-4">
                            <div class="input-group max-w-[120px]">
                                <label>Quantity</label>
                                <input type="number" id="userBatchQty" value="5" min="1" max="50">
                            </div>
                            <button onclick="generateBatchUsers()" class="bg-blue-600 text-white px-6 py-2 rounded-lg font-bold text-xs h-[38px]">GENERATE USERS</button>
                        </div>
                        <div id="batchContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6"></div>
                        <div id="batchActions" class="hidden flex justify-end gap-2 pt-4 border-t">
                            <button onclick="processBatchCreation('User', 'user')" class="bg-green-600 text-white px-6 py-2 rounded-lg font-bold text-xs">CREATE ALL</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
                <h3 class="text-gray-400 font-mono text-[10px] uppercase mb-2">Network Traffic</h3>
                <div id="networkLogs" class="h-64 overflow-y-auto bg-black p-2 rounded border border-gray-800 text-white"></div>
            </div>
            <div class="bg-gray-900 rounded-xl p-4 border border-gray-700">
                <h3 class="text-gray-400 font-mono text-[10px] uppercase mb-2">Last Response</h3>
                <pre id="jsonOutput" class="text-green-400 font-mono text-[11px] h-64 overflow-auto bg-black p-2 rounded border border-gray-800">{}</pre>
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'https://next101.genexus.ai/Id86d7fbe19651073e3bf1ab7697cbcc3f/rest';
        const entityHashes = { Activity: null, Product: null, User: null };
        const batchStore = { user: [], product: [], activity: [] };
        const liveRegistry = { users: [], products: [] };
        let pendingRequest = null;

        // Mock Lists for Creativity
        const CITIES = ["Tokyo", "Paris", "London", "San Francisco", "Sydney", "Berlin", "Seoul", "Madrid", "Toronto", "Dubai", "New York", "Singapore", "Rome", "Amsterdam"];
        const ZONES = ["North Sector", "Business District", "Old Town", "Waterfront", "Innovation Hub", "Green Park", "South Heights", "Suburban Alpha", "West Campus"];
        
        // Updated Category List
        const PRODUCT_CATEGORIES = ["Cloth", "Toy", "Book", "Accessory"];
        
        const PRODUCT_DESCS = [
            "Next-gen technology for modern living.",
            "Eco-friendly materials with premium finish.",
            "Designed by industry experts for peak performance.",
            "Compact, lightweight and extremely durable.",
            "The perfect addition to your professional workspace.",
            "High-efficiency model with intelligent controls.",
            "Hand-crafted aesthetic with industrial strength.",
            "Award-winning design and unparalleled reliability."
        ];
        
        // Updated Image URLs using Unsplash
        const PRODUCT_IMAGES = [
            "https://images.unsplash.com/photo-1542291026-7eec264c27ff?w=400&h=400&fit=crop",
            "https://images.unsplash.com/photo-1558636508-e0db3814bd1d?w=400&h=400&fit=crop",
            "https://images.unsplash.com/photo-1544947950-fa07a98d237f?w=400&h=400&fit=crop",
            "https://images.unsplash.com/photo-1523275335684-37898b6baf30?w=400&h=400&fit=crop",
            "https://images.unsplash.com/photo-1525966222134-fcfa99b8ae77?w=400&h=400&fit=crop"
        ];

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('tab-active', 'text-blue-600'));
            const targetBtn = document.getElementById(`tab-${tab}`);
            if (targetBtn) targetBtn.classList.add('tab-active');
            document.querySelectorAll('.tab-section').forEach(sec => sec.classList.add('hidden'));
            const targetSec = document.getElementById(`section-${tab}`);
            if (targetSec) targetSec.classList.remove('hidden');
        }

        function addLog(msg, type = '') {
            const logs = document.getElementById('networkLogs');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logs.appendChild(entry);
            logs.scrollTop = logs.scrollHeight;
        }

        function updateHashUI(entity) {
            const display = document.getElementById(`${entity.toLowerCase()}HashDisplay`);
            if (display) {
                if (entityHashes[entity]) {
                    display.textContent = `Hash Loaded: ${entityHashes[entity].substring(0,8)}...`;
                    display.className = "hash-badge bg-green-100 text-green-700 border border-green-200";
                } else {
                    display.textContent = "No Hash";
                    display.className = "hash-badge bg-gray-200 text-gray-600";
                }
            }
        }

        function cancelRequest() {
            document.getElementById('debugModal').classList.remove('active');
            pendingRequest = null;
        }

        function confirmRequest() {
            if (pendingRequest) {
                const { execute } = pendingRequest;
                document.getElementById('debugModal').classList.remove('active');
                pendingRequest = null;
                execute();
            }
        }

        function getProxiedUrl(targetUrl) {
            const proxyType = document.getElementById('proxySelector').value;
            if (proxyType === 'corsproxy_io') return `https://corsproxy.io/?url=${encodeURIComponent(targetUrl)}`;
            return targetUrl;
        }

        async function fetchTableData(tableName) {
            const payload = { "Operation": "list", "Table": tableName, "Key": "", "DataJSON": "" };
            try {
                const res = await fetch(getProxiedUrl(`${BASE_URL}/Data`), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const body = await res.json();
                return body.Result ? JSON.parse(body.Result) : [];
            } catch(e) { return []; }
        }

        async function fetchExistingAndGenerateActivities() {
            addLog("Syncing Foreign Keys (Users & Products)...", "log-request");
            liveRegistry.users = await fetchTableData('User');
            liveRegistry.products = await fetchTableData('Product');
            generateBatchActivities();
        }

        function generateBatchUsers() {
            const qty = parseInt(document.getElementById('userBatchQty').value) || 5;
            const container = document.getElementById('batchContainer');
            batchStore.user = [];
            container.innerHTML = '';
            
            const firstNames = ["Liam", "Olivia", "Noah", "Emma", "Oliver", "Ava", "Elijah", "Charlotte", "William", "Sophia"];
            const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez"];

            for (let i = 0; i < qty; i++) {
                const id = Math.floor(Math.random() * 9000) + 1000;
                const fName = firstNames[Math.floor(Math.random() * firstNames.length)];
                const lName = lastNames[Math.floor(Math.random() * lastNames.length)];
                
                const user = {
                    UserId: 0, 
                    UserName: `${fName} ${lName}`,
                    UserEmail: `${fName.toLowerCase()}.${lName.toLowerCase()}${id}@genexus.test`,
                    UserPassword: "Pass" + id + "!",
                    UserCity: CITIES[Math.floor(Math.random() * CITIES.length)],
                    UserZone: ZONES[Math.floor(Math.random() * ZONES.length)],
                    UserProfileImage: `https://i.pravatar.cc/150?u=${id}`,
                    UserInactive: Math.random() > 0.8,
                    UserVerified: Math.random() > 0.2
                };
                
                batchStore.user.push(user);
                const card = document.createElement('div');
                card.className = 'item-card text-xs space-y-2';
                card.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${user.UserProfileImage}" class="w-10 h-10 rounded-full border shadow-sm" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(user.UserName)}'">
                        <div>
                            <div class="font-bold text-gray-900">${user.UserName}</div>
                            <div class="text-blue-600 font-mono text-[10px]">${user.UserEmail}</div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-1 text-[10px] pt-2 border-t border-gray-100">
                        <div class="text-gray-500">City: <span class="text-gray-800 font-semibold">${user.UserCity}</span></div>
                        <div class="text-gray-500">Zone: <span class="text-gray-800 font-semibold">${user.UserZone}</span></div>
                        <div class="text-gray-500">Status: <span class="${user.UserInactive ? 'text-red-500' : 'text-green-500'}">${user.UserInactive ? 'Inactive' : 'Active'}</span></div>
                        <div class="text-gray-500">Verified: <span class="${user.UserVerified ? 'text-blue-500' : 'text-orange-500'}">${user.UserVerified ? 'Yes' : 'No'}</span></div>
                        <div class="text-gray-400 col-span-2 font-mono">PWD: ${user.UserPassword}</div>
                    </div>
                `;
                container.appendChild(card);
            }
            document.getElementById('batchActions').classList.remove('hidden');
        }

        function generateBatchProducts() {
            const qty = parseInt(document.getElementById('productBatchQty').value) || 5;
            const container = document.getElementById('batchProductContainer');
            batchStore.product = [];
            container.innerHTML = '';
            
            const prefixes = ["Classic", "Modern", "Vintage", "Urban", "Royal", "Swift", "Bold", "Pure"];
            const nouns = ["Item", "Selection", "Choice", "Edition", "Series", "Brand", "Model"];

            for (let i = 0; i < qty; i++) {
                const id = Math.floor(Math.random() * 9000);
                const category = PRODUCT_CATEGORIES[Math.floor(Math.random() * PRODUCT_CATEGORIES.length)];
                const pName = `${prefixes[Math.floor(Math.random() * prefixes.length)]} ${category} ${nouns[Math.floor(Math.random() * nouns.length)]}`;
                
                const product = {
                    ProductId: 0, 
                    ProductName: pName,
                    ProductManufacturer: "Studio " + (id % 15 + 1),
                    ProductCategory: category,
                    ProductDescription: PRODUCT_DESCS[Math.floor(Math.random() * PRODUCT_DESCS.length)],
                    ProductEANCode: "EAN-" + (500000000000 + id),
                    ProductImage: PRODUCT_IMAGES[Math.floor(Math.random() * PRODUCT_IMAGES.length)]
                };
                
                batchStore.product.push(product);
                const card = document.createElement('div');
                card.className = 'item-card text-xs flex gap-3 flex-col';
                card.innerHTML = `
                    <div class="flex gap-3">
                        <img src="${product.ProductImage}" class="w-16 h-16 rounded border object-cover shadow-sm" onerror="this.src='https://placehold.co/100x100?text=Product'">
                        <div class="flex-1">
                            <div class="font-bold text-gray-900">${product.ProductName}</div>
                            <div class="text-[10px] text-indigo-600 font-semibold">${product.ProductCategory}</div>
                            <div class="text-[9px] text-gray-400 font-mono">${product.ProductEANCode}</div>
                        </div>
                    </div>
                    <div class="pt-2 border-t border-gray-100 space-y-1">
                        <div class="text-[10px] text-gray-600 italic">"${product.ProductDescription}"</div>
                        <div class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter">Mfg: ${product.ProductManufacturer}</div>
                    </div>
                `;
                container.appendChild(card);
            }
            document.getElementById('batchProductActions').classList.remove('hidden');
        }

        function generateBatchActivities() {
            const qty = parseInt(document.getElementById('activityBatchQty').value) || 5;
            const container = document.getElementById('batchActivityContainer');
            batchStore.activity = [];
            container.innerHTML = '';
            const now = new Date().toISOString();
            
            const emptyProductEntry = liveRegistry.products.find(p => p.ProductName === "[EMPTY]");
            const emptyProductId = emptyProductEntry ? Number(emptyProductEntry.ProductId) : 0;

            const adjectives = ["quick", "detailed", "periodic", "urgent", "casual", "verified", "priority", "routine"];
            const actions = {
                "Search": ["Browsing for", "Investigating", "Filtering", "Exploring"],
                "Offer": ["Initiating bid for", "Negotiating terms for", "Proposing exchange for", "Reviewing deal for"],
                "Post": ["Publishing update", "Announcing status", "Broadcasting presence", "Synchronizing profile"]
            };

            for (let i = 0; i < qty; i++) {
                const user = liveRegistry.users[Math.floor(Math.random() * liveRegistry.users.length)] || { UserId: 1, UserName: "Unknown User" };
                const type = ["Search", "Offer", "Post"][Math.floor(Math.random() * 3)];
                const adj = adjectives[Math.floor(Math.random() * adjectives.length)];
                const act = actions[type][Math.floor(Math.random() * actions[type].length)];
                
                let prodId = 0;
                let prodNameDisplay = "None (Empty)";
                let description = "";

                if (type === "Post") {
                    prodId = emptyProductId;
                    prodNameDisplay = emptyProductEntry ? "[EMPTY]" : "ERR: No [EMPTY] in DB";
                    description = `${act} for user ${user.UserName}. A ${adj} system notification.`;
                } else {
                    const prod = liveRegistry.products[Math.floor(Math.random() * liveRegistry.products.length)];
                    if (prod) {
                        prodId = Number(prod.ProductId);
                        prodNameDisplay = prod.ProductName;
                        description = `${act} ${prodNameDisplay}. This is a ${adj} user activity log.`;
                    } else {
                        prodId = emptyProductId;
                        prodNameDisplay = "No Products in DB";
                        description = `${act} unknown items. System in ${adj} recovery mode.`;
                    }
                }

                const activity = {
                    ActivityId: 0,
                    ActivityUserId: Number(user.UserId),
                    ActivityProductId: prodId,
                    ActivityType: type,
                    ActivityDescription: description,
                    ActivityStatus: "Active",
                    ActivityDateTime: now
                };
                
                batchStore.activity.push(activity);
                const card = document.createElement('div');
                card.className = 'item-card text-xs space-y-1';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="font-bold text-gray-900">${activity.ActivityType}</div>
                        <div class="text-[10px] text-green-600 font-bold">${activity.ActivityStatus}</div>
                    </div>
                    <div class="text-gray-700 text-[10px] italic border-l-2 border-gray-200 pl-2 my-1">
                        "${activity.ActivityDescription}"
                    </div>
                    <div class="text-gray-500 text-[10px]">
                        User: <span class="text-gray-800">${user.UserName}</span> | 
                        Product: <span class="${activity.ActivityProductId === emptyProductId ? 'text-blue-500 font-semibold' : 'text-gray-800'}">
                            ${prodNameDisplay}
                        </span>
                    </div>
                `;
                container.appendChild(card);
            }
            document.getElementById('batchActivityActions').classList.remove('hidden');
        }

        async function processBatchCreation(entityName, storeKey) {
            const data = batchStore[storeKey];
            addLog(`Creating batch ${entityName}...`, 'log-request');
            for (let item of data) await apiCall(entityName, 'POST', item);
        }

        async function apiCall(entity, method, overrideData = null) {
            const form = document.getElementById(`${entity.toLowerCase()}Form`);
            const formData = form ? new FormData(form) : null;
            const rawData = formData ? Object.fromEntries(formData.entries()) : {};
            const inspectMode = document.getElementById('inspectData').checked;
            
            let entityId = (method === 'POST') ? 0 : (rawData[`${entity}Id`] || 0);
            if (overrideData) entityId = 0;

            let targetUrl = `${BASE_URL}/${entity}`;
            if (method === 'POST') targetUrl += document.getElementById('postWithId').checked ? '/0' : '';
            else targetUrl += `/${entityId}`;

            let body = null;
            if (method === 'POST' || method === 'PUT') {
                body = overrideData || {};
                if (!overrideData) {
                    if (entity === 'Activity') {
                        body = {
                            ActivityId: Number(rawData.ActivityId || 0),
                            ActivityUserId: Number(rawData.ActivityUserId),
                            ActivityProductId: Number(rawData.ActivityProductId),
                            ActivityDescription: String(rawData.ActivityDescription),
                            ActivityType: String(rawData.ActivityType),
                            ActivityStatus: String(rawData.ActivityStatus),
                            ActivityDateTime: rawData.ActivityDateTime || new Date().toISOString()
                        };
                    } else if (entity === 'Product') {
                        body = {
                            ProductId: (method === 'POST') ? 0 : Number(rawData.ProductId),
                            ProductName: String(rawData.ProductName),
                            ProductManufacturer: String(rawData.ProductManufacturer),
                            ProductCategory: String(rawData.ProductCategory),
                            ProductDescription: String(rawData.ProductDescription),
                            ProductEANCode: String(rawData.ProductEANCode),
                            ProductImage: String(rawData.ProductImage)
                        };
                    } else if (entity === 'User') {
                        body = { 
                            UserId: (method === 'POST') ? 0 : Number(rawData.UserId), 
                            UserName: String(rawData.UserName),
                            UserEmail: String(rawData.UserEmail),
                            UserPassword: String(rawData.UserPassword),
                            UserCity: String(rawData.UserCity),
                            UserZone: String(rawData.UserZone),
                            UserProfileImage: String(rawData.UserProfileImage),
                            UserInactive: rawData.UserInactive === 'true',
                            UserVerified: rawData.UserVerified === 'true'
                        };
                    }
                }
                if (method === 'PUT' && entityHashes[entity]) body.gx_md5_hash = entityHashes[entity];
            }

            const executeFetch = async () => {
                const fetchUrl = getProxiedUrl(targetUrl);
                addLog(`${method} ${targetUrl}`, 'log-request');
                try {
                    const options = { method, headers: { 'Accept': 'application/json' } };
                    if (body) { options.headers['Content-Type'] = 'application/json'; options.body = JSON.stringify(body); }
                    const response = await fetch(fetchUrl, options);
                    const result = await response.json();
                    addLog(`RES: ${response.status}`, response.ok ? 'log-response' : 'log-error');
                    document.getElementById('jsonOutput').textContent = JSON.stringify(result, null, 2);
                    if (method === 'GET' && response.ok && result.gx_md5_hash) {
                        entityHashes[entity] = result.gx_md5_hash;
                        updateHashUI(entity);
                    }
                } catch (err) { addLog(`ERROR: ${err.message}`, 'log-error'); }
            };

            if (inspectMode && (method === 'POST' || method === 'PUT')) {
                document.getElementById('debugTarget').textContent = `${method} ${targetUrl}`;
                document.getElementById('debugPayload').textContent = JSON.stringify(body, null, 2);
                document.getElementById('debugModal').classList.add('active');
                pendingRequest = { execute: executeFetch };
                document.getElementById('confirmRequestBtn').onclick = confirmRequest;
            } else {
                await executeFetch();
            }
        }
    </script>
</body>
</html>
